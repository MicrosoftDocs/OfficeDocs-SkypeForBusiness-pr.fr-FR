---
title: Routage direct via le système téléphonique
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Protocoles de routage direct
appliesto:
- Microsoft Teams
ms.openlocfilehash: 04e9507595ef721ced5d47eb58646559601c5cab
ms.sourcegitcommit: 8750f98d59e74e3835d762d510fb0e038c8f17eb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/20/2021
ms.locfileid: "51899125"
---
# <a name="direct-routing---sip-protocol"></a><span data-ttu-id="d832c-103">Routage direct - Protocole SIP</span><span class="sxs-lookup"><span data-stu-id="d832c-103">Direct Routing - SIP protocol</span></span>

<span data-ttu-id="d832c-104">Cet article décrit la façon dont le routage direct implémente le protocole SIP (Session Initiation Protocol).</span><span class="sxs-lookup"><span data-stu-id="d832c-104">This article describes how Direct Routing implements the Session Initiation Protocol (SIP).</span></span> <span data-ttu-id="d832c-105">Pour router correctement le trafic entre un contrôleur de bordure de session (SBC) et le proxy SIP, certains paramètres SIP doivent avoir des valeurs spécifiques.</span><span class="sxs-lookup"><span data-stu-id="d832c-105">To properly route traffic between a Session Border Controller (SBC) and the SIP proxy, some SIP parameters must have specific values.</span></span> <span data-ttu-id="d832c-106">Cet article est destiné aux administrateurs vocaux chargés de configurer la connexion entre le serveur SBC local et le service proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-106">This article is intended for voice administrators who are responsible for configuring the connection between the on-premises SBC and the SIP proxy service.</span></span>

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a><span data-ttu-id="d832c-107">Traitement de la demande entrante : recherche du client et de l’utilisateur</span><span class="sxs-lookup"><span data-stu-id="d832c-107">Processing the incoming request: finding the tenant and user</span></span>

<span data-ttu-id="d832c-108">Avant qu’un appel entrant ou sortant puisse être traitée, les messages OPTIONS sont échangés entre le proxy SIP et le SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-108">Before an incoming or outbound call can be processed, OPTIONS messages are exchanged between SIP Proxy and the SBC.</span></span> <span data-ttu-id="d832c-109">Ces messages OPTIONS permettent au proxy SIP de fournir les fonctionnalités autorisées à SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-109">These OPTIONS messages allow SIP Proxy to provide the allowed capabilities to SBC.</span></span> <span data-ttu-id="d832c-110">Il est important que la négociation OPTIONS soit aboutir (réponse à la demande de 200OK), ce qui permet de communiquer davantage entre SBC et le proxy SIP pour l’établissement d’appels.</span><span class="sxs-lookup"><span data-stu-id="d832c-110">It is important for OPTIONS negotiation to be successful (200OK response), allowing for further communication between SBC and SIP Proxy for establishing calls.</span></span> <span data-ttu-id="d832c-111">Les en-têtes SIP dans les messages OPTIONS de proxy SIP sont fournis à titre d’exemple ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="d832c-111">The SIP headers in an OPTIONS messages to SIP Proxy are provided as an example below:</span></span>

| <span data-ttu-id="d832c-112">Nom du paramètre</span><span class="sxs-lookup"><span data-stu-id="d832c-112">Parameter name</span></span> | <span data-ttu-id="d832c-113">Exemple de valeur</span><span class="sxs-lookup"><span data-stu-id="d832c-113">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="d832c-114">Request-URI</span><span class="sxs-lookup"><span data-stu-id="d832c-114">Request-URI</span></span> | <span data-ttu-id="d832c-115">OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="d832c-115">OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span></span> |
| <span data-ttu-id="d832c-116">Via En-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-116">Via Header</span></span> | <span data-ttu-id="d832c-117">Via : SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="d832c-117">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="d832c-118">Max-Forwards-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-118">Max-Forwards header</span></span> | <span data-ttu-id="d832c-119">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="d832c-119">Max-Forwards:68</span></span> |
| <span data-ttu-id="d832c-120">À partir de l’en-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-120">From Header</span></span> | <span data-ttu-id="d832c-121">À partir de l’en-tête de : <sip:sbc1.adatum.biz:5058></span><span class="sxs-lookup"><span data-stu-id="d832c-121">From Header From: <sip:sbc1.adatum.biz:5058></span></span> |
| <span data-ttu-id="d832c-122">À l’en-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-122">To Header</span></span> | <span data-ttu-id="d832c-123">À: <sip:sip.pstnhub.microsoft.com:5061></span><span class="sxs-lookup"><span data-stu-id="d832c-123">To: <sip:sip.pstnhub.microsoft.com:5061></span></span> |
| <span data-ttu-id="d832c-124">En-tête CSeq</span><span class="sxs-lookup"><span data-stu-id="d832c-124">CSeq header</span></span> | <span data-ttu-id="d832c-125">CSeq : 1 INVITATION</span><span class="sxs-lookup"><span data-stu-id="d832c-125">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="d832c-126">En-tête de contact</span><span class="sxs-lookup"><span data-stu-id="d832c-126">Contact Header</span></span> | <span data-ttu-id="d832c-127">Contact : <sip:sbc1.adatum.biz:50588;transport=tls></span><span class="sxs-lookup"><span data-stu-id="d832c-127">Contact: <sip:sbc1.adatum.biz:50588;transport=tls></span></span> |

> [!NOTE]
> <span data-ttu-id="d832c-128">Les en-têtes SIP ne contiennent pas d’info-utilisateur dans l’URI SIP en cours d’utilisation.</span><span class="sxs-lookup"><span data-stu-id="d832c-128">The SIP headers do not contain userinfo in the SIP URI in use.</span></span> <span data-ttu-id="d832c-129">Selon la [RFC 3261, section 19.1.1,](https://tools.ietf.org/html/rfc3261#section-19.1.1)la partie userinfo d’une URI est facultative et PEUT être absente lorsque l’hôte de destination ne notionne pas les utilisateurs ou lorsque le serveur proprement dit est la ressource identifiée.</span><span class="sxs-lookup"><span data-stu-id="d832c-129">As per [RFC 3261, section 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1), the userinfo part of a URI is optional and MAY be absent when the destination host does not have a notion of users or when the hosst itself is the resource being identified.</span></span> <span data-ttu-id="d832c-130">Si le signe @ est présent dans une URI SIP, le champ de l’utilisateur ne doit PAS être vide.</span><span class="sxs-lookup"><span data-stu-id="d832c-130">If the @ sign is present in a SIP URI, the user field MUST NOT be empty.</span></span>

<span data-ttu-id="d832c-131">Lors d’un appel entrant, le proxy SIP doit trouver le client vers lequel l’appel est destiné et trouver l’utilisateur spécifique au sein de ce client.</span><span class="sxs-lookup"><span data-stu-id="d832c-131">On an incoming call, the SIP proxy needs to find the tenant to which the call is destined and find the specific user within this tenant.</span></span> <span data-ttu-id="d832c-132">L’administrateur client peut configurer des numéros non DID, par exemple +1001, dans plusieurs locataires.</span><span class="sxs-lookup"><span data-stu-id="d832c-132">The tenant administrator might configure non-DID numbers, for example +1001, in multiple tenants.</span></span> <span data-ttu-id="d832c-133">Par conséquent, il est important de trouver le client sur lequel effectuer la recherche de nombre, car les numéros non DID peuvent être identiques dans plusieurs organisations Microsoft 365 ou Office 365 données.</span><span class="sxs-lookup"><span data-stu-id="d832c-133">Therefore, it is important to find the specific tenant on which to perform the number lookup because the non-DID numbers might be the same in multiple Microsoft 365 or Office 365 organizations.</span></span>  

<span data-ttu-id="d832c-134">Cette section décrit comment le proxy SIP trouve le client et l’utilisateur, et effectue l’authentification du SBC sur la connexion entrante.</span><span class="sxs-lookup"><span data-stu-id="d832c-134">This section describes how the SIP proxy finds the tenant and the user, and performs authentication of the SBC on the incoming connection.</span></span>

<span data-ttu-id="d832c-135">Voici un exemple de message d’invitation SIP lors d’un appel entrant :</span><span class="sxs-lookup"><span data-stu-id="d832c-135">The following is an example of the SIP Invite message on an incoming call:</span></span>

| <span data-ttu-id="d832c-136">Nom du paramètre</span><span class="sxs-lookup"><span data-stu-id="d832c-136">Parameter name</span></span> | <span data-ttu-id="d832c-137">Exemple de valeur</span><span class="sxs-lookup"><span data-stu-id="d832c-137">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="d832c-138">Request-URI</span><span class="sxs-lookup"><span data-stu-id="d832c-138">Request-URI</span></span> | <span data-ttu-id="d832c-139">INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="d832c-139">INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span></span> |
| <span data-ttu-id="d832c-140">Via En-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-140">Via Header</span></span> | <span data-ttu-id="d832c-141">Via : SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="d832c-141">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="d832c-142">Max-Forwards-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-142">Max-Forwards header</span></span> | <span data-ttu-id="d832c-143">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="d832c-143">Max-Forwards:68</span></span> |
| <span data-ttu-id="d832c-144">À partir de l’en-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-144">From Header</span></span> | <span data-ttu-id="d832c-145">À partir de l’en-tête de : <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span><span class="sxs-lookup"><span data-stu-id="d832c-145">From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span></span> |
| <span data-ttu-id="d832c-146">À l’en-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-146">To Header</span></span> | <span data-ttu-id="d832c-147">Pour : sip:+183338006777@sbc1.adatum.biz</span><span class="sxs-lookup"><span data-stu-id="d832c-147">To: sip:+183338006777@sbc1.adatum.biz</span></span> | 
| <span data-ttu-id="d832c-148">En-tête CSeq</span><span class="sxs-lookup"><span data-stu-id="d832c-148">CSeq header</span></span> | <span data-ttu-id="d832c-149">CSeq : 1 INVITATION</span><span class="sxs-lookup"><span data-stu-id="d832c-149">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="d832c-150">En-tête de contact</span><span class="sxs-lookup"><span data-stu-id="d832c-150">Contact Header</span></span> | <span data-ttu-id="d832c-151">Contact : <sip : 68712781@sbc1.adatum.biz:5058;transport=tls></span><span class="sxs-lookup"><span data-stu-id="d832c-151">Contact: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span></span> | 

<span data-ttu-id="d832c-152">Lors de la réception de l’invitation, le proxy SIP effectue les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="d832c-152">On receiving the invite, the SIP proxy performs the following steps:</span></span>

1. <span data-ttu-id="d832c-153">Vérifiez le certificat.</span><span class="sxs-lookup"><span data-stu-id="d832c-153">Check the certificate.</span></span> <span data-ttu-id="d832c-154">Sur la connexion initiale, le service de routage direct prend le nom de nom de domaine complet présenté dans l’en-tête Contact et le fait correspond au nom commun ou au nom de remplacement d’objet du certificat présenté.</span><span class="sxs-lookup"><span data-stu-id="d832c-154">On the initial connection, the Direct Routing service takes the FQDN name presented in the Contact header and matches it to the Common Name or Subject Alternative name of the presented certificate.</span></span> <span data-ttu-id="d832c-155">Le nom SBC doit correspondre à l’une des options suivantes :</span><span class="sxs-lookup"><span data-stu-id="d832c-155">The SBC name must match one of the following options:</span></span>

   - <span data-ttu-id="d832c-156">Option 1.</span><span class="sxs-lookup"><span data-stu-id="d832c-156">Option 1.</span></span> <span data-ttu-id="d832c-157">Le nom complet du nom de domaine complet présenté dans l’en-tête Contact doit correspondre au nom commun/au nom de remplacement de l’objet du certificat présenté.</span><span class="sxs-lookup"><span data-stu-id="d832c-157">The full FQDN name presented in the Contact header must match the Common Name/Subject Alternative name of the presented certificate.</span></span>  

   - <span data-ttu-id="d832c-158">Option 2.</span><span class="sxs-lookup"><span data-stu-id="d832c-158">Option 2.</span></span> <span data-ttu-id="d832c-159">La partie domaine du nom de domaine complet présenté dans l’en-tête de contact (par exemple, adatum.biz du sbc1.adatum.biz de nom de domaine complet) doit correspondre à la valeur générique dans Nom commun/Nom de remplacement d’objet (par exemple \*.adatum.biz).</span><span class="sxs-lookup"><span data-stu-id="d832c-159">The domain portion of the FQDN name presented in the Contact header (for example adatum.biz of the FQDN name sbc1.adatum.biz) must match the wildcard value in Common Name/Subject Alternative Name (for example \*.adatum.biz).</span></span>

2. <span data-ttu-id="d832c-160">Essayez de trouver un client en utilisant le nom complet de nom de domaine complet présenté dans l’en-tête Contact.</span><span class="sxs-lookup"><span data-stu-id="d832c-160">Try to find a tenant using the full FQDN name presented in the Contact header.</span></span>  

   <span data-ttu-id="d832c-161">Vérifiez si le nom de nom de domaine complet dans l’en-tête de contact (sbc1.adatum.biz) est inscrit en tant que nom DNS dans une Microsoft 365 ou Office 365 organisation.</span><span class="sxs-lookup"><span data-stu-id="d832c-161">Check if the FQDN name from the Contact header (sbc1.adatum.biz) is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="d832c-162">Si cette recherche est trouvée, la recherche de l’utilisateur est effectuée dans le client sur qui le nom de domaine complet SBC est enregistré en tant que nom de domaine.</span><span class="sxs-lookup"><span data-stu-id="d832c-162">If found, the lookup of the user is performed in the tenant that has the SBC FQDN registered as a Domain name.</span></span> <span data-ttu-id="d832c-163">Si l’étape 3 n’est pas trouvée, l’étape 3 s’applique.</span><span class="sxs-lookup"><span data-stu-id="d832c-163">If not found, Step 3 applies.</span></span>   

3. <span data-ttu-id="d832c-164">L’étape 3 s’applique uniquement si l’étape 2 a échoué.</span><span class="sxs-lookup"><span data-stu-id="d832c-164">Step 3 only applies if Step 2 failed.</span></span> 

   <span data-ttu-id="d832c-165">Supprimez la partie hôte du nom de domaine complet (FQDN) présenté dans l’en-tête du contact (nom de domaine complet : sbc12.adatum.biz, après la suppression de la partie hôte : adatum.biz), et vérifiez si ce nom est inscrit en tant que nom DNS dans une organisation Microsoft 365 ou Office 365.</span><span class="sxs-lookup"><span data-stu-id="d832c-165">Remove the host portion from the FQDN, presented in the Contact header (FQDN: sbc12.adatum.biz, after removing the host portion: adatum.biz), and check if this name is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="d832c-166">Si elle est trouvée, la recherche d’utilisateur est effectuée dans ce client.</span><span class="sxs-lookup"><span data-stu-id="d832c-166">If found, the user lookup is performed in this tenant.</span></span> <span data-ttu-id="d832c-167">Si l’appel est in found, l’appel échoue.</span><span class="sxs-lookup"><span data-stu-id="d832c-167">If not found, the call fails.</span></span>

4. <span data-ttu-id="d832c-168">En utilisant le numéro de téléphone présenté dans l’URI-demande, effectuez la recherche inversée de numéro au sein du client trouvé à l’étape 2 ou 3.</span><span class="sxs-lookup"><span data-stu-id="d832c-168">Using the phone number presented in the Request-URI, perform the reverse number lookup within the tenant found in Step 2 or 3.</span></span> <span data-ttu-id="d832c-169">Faire correspondre le numéro de téléphone présenté à l’URI SIP de l’utilisateur au sein du client trouvée à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="d832c-169">Match the presented phone number to a user SIP URI within the tenant found on the previous step.</span></span>

5. <span data-ttu-id="d832c-170">Appliquer les paramètres de ligne.</span><span class="sxs-lookup"><span data-stu-id="d832c-170">Apply trunk settings.</span></span> <span data-ttu-id="d832c-171">Recherchez les paramètres définies par l’administrateur client pour ce SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-171">Find the parameters set by the tenant admin for this SBC.</span></span>

   <span data-ttu-id="d832c-172">Microsoft ne prend pas en charge la création d’un proxy SIP tiers ou d’un serveur agent utilisateur entre le proxy SIP De Microsoft et le jeu SBC couplé, ce qui peut modifier l’URI de demande créée par le SBC couplé.</span><span class="sxs-lookup"><span data-stu-id="d832c-172">Microsoft does not support having a third-party SIP proxy or User Agent Server between the Microsoft SIP proxy and the paired SBC, which might modify the Request URI created by the paired SBC.</span></span>

   <span data-ttu-id="d832c-173">Les exigences pour les deux recherche (étapes 2 et 3) nécessaires au scénario d’interconnexion d’un SBC à plusieurs clients (scénario d’opérateur) sont couvertes plus loin dans cet article.</span><span class="sxs-lookup"><span data-stu-id="d832c-173">The requirements for the two lookups (steps 2 and 3) needed for the scenario where one SBC is interconnected to many tenants (carrier scenario) are covered later in this article.</span></span>

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a><span data-ttu-id="d832c-174">Conditions requises détaillées pour l’en-tête de contact et l’URI de demande</span><span class="sxs-lookup"><span data-stu-id="d832c-174">Detailed requirements for Contact header and Request-URI</span></span>

#### <a name="contact-header"></a><span data-ttu-id="d832c-175">En-tête de contact</span><span class="sxs-lookup"><span data-stu-id="d832c-175">Contact header</span></span>

<span data-ttu-id="d832c-176">Pour tous les messages SIP entrants (OPTIONS, INVITER) au proxy SIP Microsoft, l’en-tête de contact doit avoir le nom de fQDN SBC couplé dans le nom d’hôte URI comme suit :</span><span class="sxs-lookup"><span data-stu-id="d832c-176">For all incoming SIP messages (OPTIONS, INVITE) to the Microsoft SIP proxy, the Contact header must have the paired SBC FQDN in the URI hostname as follows:</span></span>

<span data-ttu-id="d832c-177">Syntaxe : Contact : <sip:phone ou sip address@FQDN of the SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="d832c-177">Syntax: Contact:  <sip:phone or sip address@FQDN of the SBC;transport=tls></span></span> 

<span data-ttu-id="d832c-178">Comme le [dit le RFC 3261, section 11.1,](https://tools.ietf.org/html/rfc3261#section-11.1)un champ d’en-tête de contact peut être présent dans un message OPTIONS.</span><span class="sxs-lookup"><span data-stu-id="d832c-178">As per [RFC 3261, section 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), a Contact header field MAY be present in an OPTIONS message.</span></span> <span data-ttu-id="d832c-179">Dans Routage direct, l’en-tête du contact est obligatoire.</span><span class="sxs-lookup"><span data-stu-id="d832c-179">In Direct Routing the contact header is required.</span></span> <span data-ttu-id="d832c-180">Pour les messages INVITER au format ci-dessus, pour les messages OPTIONS, le info-utilisateur peut être supprimé de l’URI SIP et uniquement des FQDN envoyés au format suivant :</span><span class="sxs-lookup"><span data-stu-id="d832c-180">For INVITE messages in format above, for OPTIONS messages the userinfo can be removed from SIP URI and only FQDN sent in format as follows:</span></span>

<span data-ttu-id="d832c-181">Syntaxe : Contact : <:FQDN du SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="d832c-181">Syntax: Contact:  <sip:FQDN of the SBC;transport=tls></span></span>

<span data-ttu-id="d832c-182">Ce nom (FQDN) doit également se trouver dans le ou les champs Nom commun ou Autre objet du certificat présenté.</span><span class="sxs-lookup"><span data-stu-id="d832c-182">This name (FQDN) must also be in the Common Name or Subject Alternative name field(s) of the presented certificate.</span></span> <span data-ttu-id="d832c-183">Microsoft prend en charge l’utilisation de valeurs génériques des noms dans les champs Nom commun ou Autre objet du certificat.</span><span class="sxs-lookup"><span data-stu-id="d832c-183">Microsoft supports using wildcard values of the name(s) in the Common Name or Subject Alternative Name fields of the certificate.</span></span>   

<span data-ttu-id="d832c-184">La prise en charge des caractères génériques est décrite dans [la rubrique RFC 2818, section 3.1.](https://tools.ietf.org/html/rfc2818#section-3.1)</span><span class="sxs-lookup"><span data-stu-id="d832c-184">The support for wildcards is described in [RFC 2818, section 3.1](https://tools.ietf.org/html/rfc2818#section-3.1).</span></span> <span data-ttu-id="d832c-185">Plus précisément :</span><span class="sxs-lookup"><span data-stu-id="d832c-185">Specifically:</span></span>

<span data-ttu-id="d832c-186">*« Les noms peuvent contenir le caractère générique, qui est considéré comme correspondre à n’importe quel composant de nom de domaine ou \* fragment de composant unique. Par exemple, .a.com fait la correspondance foo.a.com mais pas \* bar.foo.a.com. f.com correspond à foo.com mais pas \* bar.com ».*</span><span class="sxs-lookup"><span data-stu-id="d832c-186">*"Names may contain the wildcard character \* which is considered to match any single domain name component or component fragment. E.g., \*.a.com matches foo.a.com but not bar.foo.a.com. f\*.com matches foo.com but not bar.com."*</span></span>

<span data-ttu-id="d832c-187">Si lebc envoie plusieurs valeurs dans l’en-tête Contact présenté dans un message SIP, seule la partie FQDN de la première valeur de l’en-tête de contact est utilisée.</span><span class="sxs-lookup"><span data-stu-id="d832c-187">If more than one value in the Contact header presented in a SIP message is sent by the SBC, only the FQDN portion of the first value of the Contact header is used.</span></span>

<span data-ttu-id="d832c-188">En règle générale, pour le routage direct, il est important que le nom de nom deqdN soit utilisé pour remplir l’URI SIP au lieu de l’adresse IP.</span><span class="sxs-lookup"><span data-stu-id="d832c-188">As rule of thumb for Direct Routing, it is important that FQDN is used to populate SIP URI instead of IP.</span></span> <span data-ttu-id="d832c-189">Un message INVITATION ou OPTIONS entrant au proxy SIP avec en-tête Contact dans lequel le nom d’hôte est représenté par IP et non FQDN, la connexion sera refusée avec l’option 403 Interdit.</span><span class="sxs-lookup"><span data-stu-id="d832c-189">An incoming INVITE or OPTIONS message to SIP Proxy with Contact header where hostname is represented by IP and not FQDN, the connection will be refused with 403 Forbidden.</span></span>

#### <a name="request-uri"></a><span data-ttu-id="d832c-190">Request-URI</span><span class="sxs-lookup"><span data-stu-id="d832c-190">Request-URI</span></span> 

<span data-ttu-id="d832c-191">Pour tous les appels entrants, l’URI de demande est utilisée pour faire correspondre le numéro de téléphone à un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d832c-191">For all incoming calls, the Request-URI is used to match the phone number to a user.</span></span>   

<span data-ttu-id="d832c-192">Pour l’instant, le numéro de téléphone doit contenir un signe plus (+), comme illustré dans l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="d832c-192">Currently The phone number must contain a plus sign (+) as shown in the following example.</span></span> 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a><span data-ttu-id="d832c-193">Considérations en Record-Route en-têtes de contacts et de contacts</span><span class="sxs-lookup"><span data-stu-id="d832c-193">Contact and Record-Route headers considerations</span></span>

<span data-ttu-id="d832c-194">Le proxy SIP doit calculer le prochain saut de FQDN pour les nouvelles transactions client de boîte de dialogue (par exemple Bye ou Re-Invite) et lors de la réponse aux options SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-194">The SIP proxy needs to calculate the next hop FQDN for new in-dialog client transactions (for example Bye or Re-Invite), and when replying to SIP Options.</span></span> <span data-ttu-id="d832c-195">Les contacts ou les Record-Route sont utilisés.</span><span class="sxs-lookup"><span data-stu-id="d832c-195">Either Contact or Record-Route are used.</span></span> 

<span data-ttu-id="d832c-196">Conformément à la [section 8.1.1.8 de la fonction RFC 3261,](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)l’en-tête du contact est requis dans toute demande qui peut entraîner la génération d’une nouvelle boîte de dialogue.</span><span class="sxs-lookup"><span data-stu-id="d832c-196">According to [RFC 3261, section 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8), Contact header is required in any request that can result in a new dialog.</span></span> <span data-ttu-id="d832c-197">La Record-Route n’est nécessaire que si un proxy souhaite rester sur le chemin des demandes futures dans une boîte de dialogue.</span><span class="sxs-lookup"><span data-stu-id="d832c-197">The Record-Route is only required if a proxy wants to stay on the path of future requests in a dialog.</span></span> <span data-ttu-id="d832c-198">Si un SBC proxy est utilisé avec l’optimisation des médias locaux pour le [routage](./direct-routing-media-optimization.md)direct, un itinéraire d’enregistrement doit être configuré comme serveur proxy pour rester sur l’itinéraire.</span><span class="sxs-lookup"><span data-stu-id="d832c-198">If a proxy SBC is in use with [Local Media Optimization for Direct Routing](./direct-routing-media-optimization.md), a record route will need to be configured as the proxy SBC needs to stay in the route.</span></span> 

<span data-ttu-id="d832c-199">Microsoft recommande d’utiliser uniquement l’en-tête de contact si un SBC proxy n’est pas utilisé :</span><span class="sxs-lookup"><span data-stu-id="d832c-199">Microsoft recommends using only Contact header if a proxy SBC is not used:</span></span>

- <span data-ttu-id="d832c-200">Par [RFC 3261, section 20.30,](https://tools.ietf.org/html/rfc3261#section-20.30)Record-Route est utilisé si un proxy souhaite rester sur le chemin des demandes futures dans une boîte de dialogue, ce qui n’est pas indispensable si aucun serveur SBC proxy n’est configuré, car tout le trafic est entre le proxy SIP Microsoft et le SBC couplé.</span><span class="sxs-lookup"><span data-stu-id="d832c-200">Per [RFC 3261, section 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route is used if a proxy wants to stay on the path of future requests in a dialog, which is not essential if no proxy SBC is configured as all traffic goes between the Microsoft SIP proxy and the paired SBC.</span></span> 

- <span data-ttu-id="d832c-201">Le proxy MICROSOFT SIP utilise uniquement l’en-tête de contact (et non l’enregistrement-itinéraire) pour déterminer le saut suivant lors de l’envoi d’options ping sortantes.</span><span class="sxs-lookup"><span data-stu-id="d832c-201">The Microsoft SIP proxy uses only Contact header (not Record-Route) to determine the next hop when sending outbound ping Options.</span></span> <span data-ttu-id="d832c-202">La configuration d’un seul paramètre (Contact) au lieu de deux (Contact et Record-Route) simplifie l’administration si un SBC proxy n’est pas utilisé.</span><span class="sxs-lookup"><span data-stu-id="d832c-202">Configuring only one parameter (Contact) instead of two (Contact and Record-Route) simplifies the administration if a proxy SBC is not in use.</span></span> 

<span data-ttu-id="d832c-203">Pour calculer le saut suivant, le proxy SIP utilise :</span><span class="sxs-lookup"><span data-stu-id="d832c-203">To calculate the next hop, the SIP proxy uses:</span></span>

- <span data-ttu-id="d832c-204">Priorité 1.</span><span class="sxs-lookup"><span data-stu-id="d832c-204">Priority 1.</span></span> <span data-ttu-id="d832c-205">Record-Route de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="d832c-205">Top-level Record-Route.</span></span> <span data-ttu-id="d832c-206">Si la liste de Record-Route de niveau supérieur contient le nom de nom de domaine complet, le nom de nom de domaine complet est utilisé pour établir la connexion entrante sortante à la boîte de dialogue.</span><span class="sxs-lookup"><span data-stu-id="d832c-206">If the top-level Record-Route contains the FQDN name, the FQDN name is used to make the outbound in-dialog connection.</span></span>

- <span data-ttu-id="d832c-207">Priorité 2.</span><span class="sxs-lookup"><span data-stu-id="d832c-207">Priority 2.</span></span> <span data-ttu-id="d832c-208">En-tête du contact.</span><span class="sxs-lookup"><span data-stu-id="d832c-208">Contact header.</span></span> <span data-ttu-id="d832c-209">Si Record-Route n’existe pas, le proxy SIP recherche la valeur de l’en-tête Contact pour établir la connexion sortante.</span><span class="sxs-lookup"><span data-stu-id="d832c-209">If Record-Route does not exist, the SIP proxy will look up the value of the Contact header to make the outbound connection.</span></span> <span data-ttu-id="d832c-210">(Il s’agit de la configuration recommandée.)</span><span class="sxs-lookup"><span data-stu-id="d832c-210">(This is the recommended configuration.)</span></span>

<span data-ttu-id="d832c-211">Si des contacts et Record-Route sont utilisés, les valeurs de l’administrateur SBC doivent rester identiques, ce qui occasionne des frais d’administration.</span><span class="sxs-lookup"><span data-stu-id="d832c-211">If both Contact and Record-Route are used, the SBC administrator must keep their values identical, which causes administrative overhead.</span></span> 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a><span data-ttu-id="d832c-212">Utilisation du nom de nom de domaine complet dans Contact ou Record-Route</span><span class="sxs-lookup"><span data-stu-id="d832c-212">Use of FQDN name in Contact or Record-Route</span></span>

<span data-ttu-id="d832c-213">L’utilisation d’une adresse IP n’est pas prise en charge Record-Route ou contact.</span><span class="sxs-lookup"><span data-stu-id="d832c-213">Use of an IP address is not supported in either Record-Route or Contact.</span></span> <span data-ttu-id="d832c-214">La seule option prise en charge est un nom de domaine complet (FQDN) qui doit correspondre au nom commun ou au nom de remplacement de l’objet du certificat SBC (les valeurs génériques du certificat sont pris en charge).</span><span class="sxs-lookup"><span data-stu-id="d832c-214">The only supported option is an FQDN, which must match either the Common Name or Subject Alternative Name of the SBC certificate (wildcard values in the certificate are supported).</span></span>

- <span data-ttu-id="d832c-215">Si une adresse IP est présentée dans l’itinéraire ou le contact d’enregistrement, la vérification du certificat échoue et l’appel échoue.</span><span class="sxs-lookup"><span data-stu-id="d832c-215">If an IP address is presented in Record-route or Contact, the certificate check fails and the call fails.</span></span>

- <span data-ttu-id="d832c-216">Si le nom de domaine complet (FQDN) ne correspond pas à la valeur du nom de remplacement commun ou objet dans le certificat présenté, l’appel échoue.</span><span class="sxs-lookup"><span data-stu-id="d832c-216">If the FQDN does not match the value of the Common or Subject Alternative Name in the presented certificate, the call fails.</span></span> 

## <a name="inbound-call-sip-dialog-description"></a><span data-ttu-id="d832c-217">Appel entrant : description de la boîte de dialogue SIP</span><span class="sxs-lookup"><span data-stu-id="d832c-217">Inbound call: SIP dialog description</span></span>

<span data-ttu-id="d832c-218">Le tableau suivant récapitule les différences de flux d’appels et les similitudes entre les modes sans contournement et contournement :</span><span class="sxs-lookup"><span data-stu-id="d832c-218">The following table below summarizes the call flow differences and similarities between non-bypass and bypass modes:</span></span>

| <span data-ttu-id="d832c-219">Nom du paramètre</span><span class="sxs-lookup"><span data-stu-id="d832c-219">Parameter name</span></span> | <span data-ttu-id="d832c-220">Mode sans contournement</span><span class="sxs-lookup"><span data-stu-id="d832c-220">Non-bypass mode</span></span> | <span data-ttu-id="d832c-221">Mode contournement</span><span class="sxs-lookup"><span data-stu-id="d832c-221">Bypass mode</span></span>
| :---------------------  |:---------------------- |:----------------|
| <span data-ttu-id="d832c-222">Media candidates in 183 and 200 messages coming from</span><span class="sxs-lookup"><span data-stu-id="d832c-222">Media candidates in 183 and 200 messages coming from</span></span> | <span data-ttu-id="d832c-223">Processeurs multimédias</span><span class="sxs-lookup"><span data-stu-id="d832c-223">Media processors</span></span> | <span data-ttu-id="d832c-224">Clients</span><span class="sxs-lookup"><span data-stu-id="d832c-224">Clients</span></span> | 
| <span data-ttu-id="d832c-225">Nombre de messages SBC de 183 reçus</span><span class="sxs-lookup"><span data-stu-id="d832c-225">Number of 183 messages SBC can receive</span></span> | <span data-ttu-id="d832c-226">Un par session</span><span class="sxs-lookup"><span data-stu-id="d832c-226">One per session</span></span> | <span data-ttu-id="d832c-227">Multiple</span><span class="sxs-lookup"><span data-stu-id="d832c-227">Multiple</span></span> | 
| <span data-ttu-id="d832c-228">L’appel peut être avec la réponse de la seule réponse (183)</span><span class="sxs-lookup"><span data-stu-id="d832c-228">Call can be with provisional answer (183)</span></span> | <span data-ttu-id="d832c-229">Oui</span><span class="sxs-lookup"><span data-stu-id="d832c-229">Yes</span></span> | <span data-ttu-id="d832c-230">Oui</span><span class="sxs-lookup"><span data-stu-id="d832c-230">Yes</span></span> |
| <span data-ttu-id="d832c-231">L’appel peut être sans réponse de la seule réponse (183)</span><span class="sxs-lookup"><span data-stu-id="d832c-231">Call can be without provisional answer (183)</span></span> | <span data-ttu-id="d832c-232">Oui</span><span class="sxs-lookup"><span data-stu-id="d832c-232">Yes</span></span> | <span data-ttu-id="d832c-233">Oui</span><span class="sxs-lookup"><span data-stu-id="d832c-233">Yes</span></span> |

###  <a name="non-media-bypass-flow"></a><span data-ttu-id="d832c-234">Flux de dérivation non multimédia</span><span class="sxs-lookup"><span data-stu-id="d832c-234">Non-media bypass flow</span></span>

<span data-ttu-id="d832c-235">Un Teams utilisateur peut avoir plusieurs points de terminaison en même temps.</span><span class="sxs-lookup"><span data-stu-id="d832c-235">A Teams user might have multiple endpoints at the same time.</span></span> <span data-ttu-id="d832c-236">Par exemple, Teams pour Windows client, Teams pour iPhone client et Teams Téléphone (Teams client Android).</span><span class="sxs-lookup"><span data-stu-id="d832c-236">For example, Teams for Windows client, Teams for iPhone client, and Teams Phone (Teams Android client).</span></span> <span data-ttu-id="d832c-237">Chaque point de terminaison peut signaler un repos HTTP comme suit :</span><span class="sxs-lookup"><span data-stu-id="d832c-237">Each endpoint might signal an HTTP rest as follows:</span></span>

-   <span data-ttu-id="d832c-238">Progression des appels – converti par le proxy SIP au message SIP 180.</span><span class="sxs-lookup"><span data-stu-id="d832c-238">Call progress – converted by the SIP proxy to the SIP message 180.</span></span> <span data-ttu-id="d832c-239">Lors de la réception du message 180, le SBC doit générer une sonnerie locale.</span><span class="sxs-lookup"><span data-stu-id="d832c-239">On receiving message 180, the SBC must generate local ringing.</span></span>

-   <span data-ttu-id="d832c-240">Réponse multimédia : convertis par le proxy SIP en message 183 avec les candidats multimédias dans le protocole SDP (Session Description Protocol).</span><span class="sxs-lookup"><span data-stu-id="d832c-240">Media answer – converted by the SIP proxy to message 183 with media candidates in Session Description Protocol (SDP).</span></span> <span data-ttu-id="d832c-241">À la réception du message 183, le SBC s’attend à se connecter aux candidats aux médias reçus dans le message SDP.</span><span class="sxs-lookup"><span data-stu-id="d832c-241">On receiving message 183, the SBC expects to connect to the media candidates received in the SDP message.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="d832c-242">Dans certains cas, la réponse multimédia n’est peut-être pas générée et le point de fin peut répondre par un message « Appel accepté ».</span><span class="sxs-lookup"><span data-stu-id="d832c-242">In some cases the Media answer might not be generated, and the end point might answer with “Call Accepted” message.</span></span>

-   <span data-ttu-id="d832c-243">Appel accepté – converti par le proxy SIP en message SIP 200 avec SDP.</span><span class="sxs-lookup"><span data-stu-id="d832c-243">Call accepted – converted by the SIP proxy to SIP message 200 with SDP.</span></span> <span data-ttu-id="d832c-244">À la réception du message 200, le SBC est censé envoyer et recevoir des médias vers et depuis les candidats au programme SDP fournis.</span><span class="sxs-lookup"><span data-stu-id="d832c-244">On receiving message 200, the SBC is expected to send and receive media to and from the provided SDP candidates.</span></span>

    > [!NOTE]
    > <span data-ttu-id="d832c-245">Le routage direct ne prend pas en charge l’invitation d’offre retardée (invitation sans SDP).</span><span class="sxs-lookup"><span data-stu-id="d832c-245">Direct Routing does not support Delayed Offer Invite (Invite without SDP).</span></span>

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a><span data-ttu-id="d832c-246">Plusieurs points de terminaison avec réponse inserer</span><span class="sxs-lookup"><span data-stu-id="d832c-246">Multiple endpoints ringing with provisional answer</span></span>

1.  <span data-ttu-id="d832c-247">À la réception de la première invitation de la part du SBC, le proxy SIP envoie le message « SiP SIP/2.0 100 Trying » et informe tous les points de terminaison de l’utilisateur final concernant l’appel entrant.</span><span class="sxs-lookup"><span data-stu-id="d832c-247">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="d832c-248">Dès notification, chaque point de terminaison commence à sonner et envoie des messages « Avancement des appels » au proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-248">Upon notification, each endpoint will start ringing and sending "Call progress” messages to the SIP proxy.</span></span> <span data-ttu-id="d832c-249">Étant donné qu Teams utilisateur peut avoir plusieurs points de fin, le proxy SIP peut recevoir plusieurs messages de progression des appels.</span><span class="sxs-lookup"><span data-stu-id="d832c-249">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="d832c-250">Pour chaque message de progression des appels reçu de clients, le proxy SIP convertit le message de progression des appels en message SIP « SiP SIP/2.0 180 Trying ».</span><span class="sxs-lookup"><span data-stu-id="d832c-250">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span> <span data-ttu-id="d832c-251">L’intervalle d’envoi de tels messages est défini par l’intervalle des messages de réception du contrôleur d’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-251">The interval for sending such messages is defined by the interval of the receiving messages from the Call Controller.</span></span> <span data-ttu-id="d832c-252">Dans le diagramme suivant, deux messages 180 sont générés par le proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-252">In the following diagram, there are two 180 messages generated by the SIP proxy.</span></span> <span data-ttu-id="d832c-253">Ces messages proviennent des deux points Teams terminaison de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d832c-253">These messages come from the two Teams endpoints of the user.</span></span> <span data-ttu-id="d832c-254">Chacun des clients a un ID de balise unique.</span><span class="sxs-lookup"><span data-stu-id="d832c-254">The clients each have a unique Tag ID.</span></span>  <span data-ttu-id="d832c-255">Chaque message provenant d’un point de terminaison différent sera une session distincte (la « balise » du paramètre dans le champ « À » sera différente).</span><span class="sxs-lookup"><span data-stu-id="d832c-255">Every message coming from a different endpoint will be a separate session (the parameter “tag” in the “To” field will be different).</span></span> <span data-ttu-id="d832c-256">Mais un point de terminaison peut ne pas générer le message 180 et envoyer le message 183 immédiatement, comme indiqué dans le diagramme suivant.</span><span class="sxs-lookup"><span data-stu-id="d832c-256">But an endpoint might not generate message 180 and send message 183 right away as shown in the following diagram.</span></span>

4.  <span data-ttu-id="d832c-257">Lorsqu’un point de terminaison génère un message De réponse multimédia avec les adresses IP des candidats multimédias du point de terminaison, le proxy SIP convertit le message reçu en message « Avancement de la session SIP 183 » avec le SDP du client remplacé par le SDP provenant du processeur de média.</span><span class="sxs-lookup"><span data-stu-id="d832c-257">Once an endpoint generates a Media Answer message with the IP addresses of endpoint’s media candidates, the SIP proxy converts the message received to a "SIP 183 Session Progress" message with the SDP from the client replaced by the SDP from the Media Processor.</span></span> <span data-ttu-id="d832c-258">Dans le diagramme suivant, le point de terminaison de la fork 2 a répondu à l’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-258">In the following diagram, the endpoint from Fork 2 answered the call.</span></span> <span data-ttu-id="d832c-259">Si la ligne n’est pas contourné, le message SIP 183 n’est généré qu’une seule fois (ring bot ou point de fin du client).</span><span class="sxs-lookup"><span data-stu-id="d832c-259">If the trunk is non-bypassed, the 183 SIP message is generated only once (either Ring Bot or Client End Point).</span></span> <span data-ttu-id="d832c-260">La 183 peut se faire sur une bifurcation existante ou en démarrer une nouvelle.</span><span class="sxs-lookup"><span data-stu-id="d832c-260">The 183 might come on an existing fork or start a new one.</span></span>

5.  <span data-ttu-id="d832c-261">Un message d’acceptation d’appel est envoyé avec les derniers candidats au point de terminaison ayant accepté l’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-261">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="d832c-262">Le message d’acceptation d’appel est converti en message SIP 200.</span><span class="sxs-lookup"><span data-stu-id="d832c-262">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="d832c-263">![Diagramme montrant plusieurs points de terminaison avec réponse inser](media/direct-routing-protocols-1.png)</span><span class="sxs-lookup"><span data-stu-id="d832c-263">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-1.png)</span></span>

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a><span data-ttu-id="d832c-264">Plusieurs points de terminaison avec sonnerie sans réponse inerser</span><span class="sxs-lookup"><span data-stu-id="d832c-264">Multiple endpoints ringing without provisional answer</span></span>

1.  <span data-ttu-id="d832c-265">À la réception de la première invitation de la part du SBC, le proxy SIP envoie le message « SiP SIP/2.0 100 Trying » et informe tous les points de terminaison de l’utilisateur final concernant l’appel entrant.</span><span class="sxs-lookup"><span data-stu-id="d832c-265">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="d832c-266">Dès notification, chaque point de terminaison commence à sonner et envoie le message « Avancement des appels » au proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-266">Upon notification, each endpoint will start ringing and sending the message "Call progress” to the SIP proxy.</span></span> <span data-ttu-id="d832c-267">Étant donné qu Teams utilisateur peut avoir plusieurs points de fin, le proxy SIP peut recevoir plusieurs messages de progression des appels.</span><span class="sxs-lookup"><span data-stu-id="d832c-267">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="d832c-268">Pour chaque message de progression des appels reçu de clients, le proxy SIP convertit le message de progression des appels en message SIP « SiP SIP/2.0 180 Trying ».</span><span class="sxs-lookup"><span data-stu-id="d832c-268">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span>  <span data-ttu-id="d832c-269">L’intervalle d’envoi des messages est défini par l’intervalle de réception des messages du contrôleur d’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-269">The interval for sending the messages is defined by the interval of receiving the messages from the Call Controller.</span></span> <span data-ttu-id="d832c-270">L’image ci-dessous montre deux messages générés par le proxy SIP : un utilisateur s’est connecté à trois clients Teams et chaque client envoie la progression des appels.</span><span class="sxs-lookup"><span data-stu-id="d832c-270">On the picture below there are two 180 messages generated by the SIP proxy, meaning that user logged into three Teams clients and each client send the call progress.</span></span> <span data-ttu-id="d832c-271">Chaque message sera une session distincte (la « balise » du paramètre dans le champ « À » est différente)</span><span class="sxs-lookup"><span data-stu-id="d832c-271">Every message will be a separate session (parameter “tag” in “To” field is different)</span></span>

4.  <span data-ttu-id="d832c-272">Un message d’acceptation d’appel est envoyé avec les derniers candidats au point de terminaison ayant accepté l’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-272">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="d832c-273">Le message d’acceptation d’appel est converti en message SIP 200.</span><span class="sxs-lookup"><span data-stu-id="d832c-273">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="d832c-274">![Diagramme montrant plusieurs points de terminaison avec sonnerie sans réponse inser](media/direct-routing-protocols-2.png)</span><span class="sxs-lookup"><span data-stu-id="d832c-274">![Diagram showing multiple endpoints ringing without provisional answer](media/direct-routing-protocols-2.png)</span></span>

### <a name="media-bypass-flow"></a><span data-ttu-id="d832c-275">Flux de dérivation média</span><span class="sxs-lookup"><span data-stu-id="d832c-275">Media bypass flow</span></span>

<span data-ttu-id="d832c-276">Les mêmes messages (100 Tentative, 180, 183) sont utilisés dans le scénario de dérivation média.</span><span class="sxs-lookup"><span data-stu-id="d832c-276">The same messages (100 Trying, 180, 183) are used in the media bypass scenario.</span></span> 

<span data-ttu-id="d832c-277">Le schéma ci-dessous montre un exemple de flux d’appels de contournement.</span><span class="sxs-lookup"><span data-stu-id="d832c-277">The schema below shows an example of the bypass call flow.</span></span> 

> [!NOTE]
> <span data-ttu-id="d832c-278">Les candidats aux médias peuvent se trouver sur différents points de terminaison.</span><span class="sxs-lookup"><span data-stu-id="d832c-278">The media candidates can come from different endpoints.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="d832c-279">![Diagramme montrant plusieurs points de terminaison avec réponse inser](media/direct-routing-protocols-3.png)</span><span class="sxs-lookup"><span data-stu-id="d832c-279">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-3.png)</span></span>

## <a name="replaces-option"></a><span data-ttu-id="d832c-280">Option Remplace</span><span class="sxs-lookup"><span data-stu-id="d832c-280">Replaces option</span></span>

<span data-ttu-id="d832c-281">Le SBC doit prendre en charge l’invitation par remplacement.</span><span class="sxs-lookup"><span data-stu-id="d832c-281">The SBC must support Invite with Replaces.</span></span>

## <a name="size-of-sdp-considerations"></a><span data-ttu-id="d832c-282">Taille des considérations en considération de la taille du SDP</span><span class="sxs-lookup"><span data-stu-id="d832c-282">Size of SDP considerations</span></span>

<span data-ttu-id="d832c-283">L’interface de routage direct peut envoyer un message SIP dépassant 1 500 octets.</span><span class="sxs-lookup"><span data-stu-id="d832c-283">The Direct Routing interface might send a SIP message exceeding 1,500 bytes.</span></span>  <span data-ttu-id="d832c-284">C’est principalement la taille du projet de projet qui en est à l’origine.</span><span class="sxs-lookup"><span data-stu-id="d832c-284">The size of SDP primarily causes this.</span></span> <span data-ttu-id="d832c-285">Toutefois, si une ligne UDP se trouve derrière le SBC, il est possible que le message soit rejeté s’il est transmis à partir du proxy SIP Microsoft vers la ligne nonmodifiée.</span><span class="sxs-lookup"><span data-stu-id="d832c-285">However, if there is a UDP trunk behind the SBC, it might reject the message if it is forwarded from the Microsoft SIP proxy to the trunk unmodified.</span></span> <span data-ttu-id="d832c-286">Lors de l’envoi du message aux ligne UDP, Microsoft recommande de faire désétrépcher certaines valeurs de SDP sur le SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-286">Microsoft recommends stripping some values in SDP on the SBC when sending the message to the UDP trunks.</span></span> <span data-ttu-id="d832c-287">Par exemple, les candidats ice ou les codecs inutilisés peuvent être supprimés.</span><span class="sxs-lookup"><span data-stu-id="d832c-287">For example, the ICE candidates or unused codecs can be removed.</span></span>

## <a name="call-transfer"></a><span data-ttu-id="d832c-288">Transfert d’appel</span><span class="sxs-lookup"><span data-stu-id="d832c-288">Call transfer</span></span>

<span data-ttu-id="d832c-289">Le routage direct prend en charge deux méthodes de transfert d’appel :</span><span class="sxs-lookup"><span data-stu-id="d832c-289">Direct Routing supports two methods for call transfer:</span></span>

- <span data-ttu-id="d832c-290">Option 1.</span><span class="sxs-lookup"><span data-stu-id="d832c-290">Option 1.</span></span> <span data-ttu-id="d832c-291">Les processus proxy SIP font référence au client localement et agit comme arbitre, comme décrit dans la section 7.1 de la RFC 3892.</span><span class="sxs-lookup"><span data-stu-id="d832c-291">SIP proxy processes Refer from the client locally and acts as a Referee as described in section 7.1 of RFC 3892.</span></span>

  <span data-ttu-id="d832c-292">Avec cette option, le proxy SIP termine le transfert et ajoute une nouvelle invitation.</span><span class="sxs-lookup"><span data-stu-id="d832c-292">With this option, the SIP proxy terminates the transfer and adds a new Invite.</span></span> 


- <span data-ttu-id="d832c-293">Option 2.</span><span class="sxs-lookup"><span data-stu-id="d832c-293">Option 2.</span></span> <span data-ttu-id="d832c-294">Le proxy SIP envoie la référence au SBC et agit comme transféreur comme décrit dans la Section 6 de la RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="d832c-294">SIP proxy sends the Refer to the SBC and acts as a Transferor as describing in Section 6 of RFC 5589.</span></span>

  <span data-ttu-id="d832c-295">Avec cette option, le proxy SIP envoie un référence au SBC et s’attend à ce qu’il gère entièrement le transfert.</span><span class="sxs-lookup"><span data-stu-id="d832c-295">With this option, the SIP proxy sends a Refer to the SBC and expects the SBC to handle the Transfer fully.</span></span>

<span data-ttu-id="d832c-296">Le proxy SIP sélectionne la méthode en fonction des fonctionnalités signalées par le SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-296">The SIP proxy selects the method based on the capabilities reported by the SBC.</span></span> <span data-ttu-id="d832c-297">Si le SBC indique qu’il prend en charge la méthode « Référence », le proxy SIP utilise l’option 2 pour les transferts d’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-297">If the SBC indicates that it supports the method “Refer”, the SIP proxy will use Option 2 for call transfers.</span></span>

<span data-ttu-id="d832c-298">Voici un exemple de SBC envoyant le message que la méthode Référence est prise en charge :</span><span class="sxs-lookup"><span data-stu-id="d832c-298">The following is an example of an SBC sending the message that the Refer method is supported:</span></span>

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

<span data-ttu-id="d832c-299">Si le SBC n’indique pas qu’il s’agit d’une méthode prise en charge, le routage direct utilise l’option 1 (le proxy SIP agit comme arbitre).</span><span class="sxs-lookup"><span data-stu-id="d832c-299">If the SBC doesn’t indicate that Refer as a supported method, Direct Routing will use Option 1 (SIP proxy acts as a Referee) .</span></span> <span data-ttu-id="d832c-300">Le SBC doit également indiquer qu’il prend en charge la méthode Notifier :</span><span class="sxs-lookup"><span data-stu-id="d832c-300">The SBC  must also signal that it supports the Notify method:</span></span>

<span data-ttu-id="d832c-301">Exemple de SBC indiquant que la méthode Référence n’est pas prise en charge :</span><span class="sxs-lookup"><span data-stu-id="d832c-301">Example of SBC indicating that Refer method is not supported:</span></span>

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a><span data-ttu-id="d832c-302">Les processus proxy SIP font référence au client localement et agit en tant qu’arbitre</span><span class="sxs-lookup"><span data-stu-id="d832c-302">SIP proxy processes Refer from the client locally and acts as a Referee</span></span>

<span data-ttu-id="d832c-303">Si la SBC indique que la méthode Référence n’est pas prise en charge, le proxy SIP agit comme arbitre.</span><span class="sxs-lookup"><span data-stu-id="d832c-303">If the SBC indicated that the Refer method is not supported, the SIP proxy acts as a Referee.</span></span> 

<span data-ttu-id="d832c-304">La demande de référence provenant du client sera résiliée sur le proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-304">The Refer request that comes from the client will be terminated on the SIP proxy.</span></span> <span data-ttu-id="d832c-305">(La demande de référence du client s’affiche sous la forme « Transfert d’appel vers Dave » dans le diagramme suivant.</span><span class="sxs-lookup"><span data-stu-id="d832c-305">(The Refer request from the client is shown as “Call transfer to Dave” in the following diagram.</span></span>  <span data-ttu-id="d832c-306">Pour plus d’informations, voir la section 7.1 de [la rubrique RFC 3892.](https://www.ietf.org/rfc/rfc3892.txt)</span><span class="sxs-lookup"><span data-stu-id="d832c-306">For more information, see section 7.1 of [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt).</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="d832c-307">![Diagramme montrant plusieurs points de terminaison avec réponse inser](media/direct-routing-protocols-4.png)</span><span class="sxs-lookup"><span data-stu-id="d832c-307">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-4.png)</span></span>

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a><span data-ttu-id="d832c-308">Le proxy SIP envoie la référence au SBC et agit en tant que transféreur</span><span class="sxs-lookup"><span data-stu-id="d832c-308">SIP proxy send the Refer to the SBC and acts as a Transferor</span></span>

<span data-ttu-id="d832c-309">Il s’agit de la méthode préférée pour les transferts d’appel, et elle est obligatoire pour les appareils qui souhaitent obtenir la certification de dérivation média.</span><span class="sxs-lookup"><span data-stu-id="d832c-309">This is the preferred method for call transfers, and it is mandatory for devices seeking media bypass certification.</span></span> <span data-ttu-id="d832c-310">Le transfert d’appel sans que SBC puisse gérer le référencement n’est pas pris en charge en mode d’évitement média.</span><span class="sxs-lookup"><span data-stu-id="d832c-310">Call Transfer without the SBC being able to handle Refer is not supported in media bypass mode.</span></span> 

<span data-ttu-id="d832c-311">La norme est expliquée à la section 6 du RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="d832c-311">The standard is explained in Section 6 of RFC 5589.</span></span> <span data-ttu-id="d832c-312">Les appels d’offre associés sont les autres :</span><span class="sxs-lookup"><span data-stu-id="d832c-312">The related RFCs are:</span></span>

- [<span data-ttu-id="d832c-313">Contrôle d’appel SIP (Session Initiation Protocol) - Transfert</span><span class="sxs-lookup"><span data-stu-id="d832c-313">Session Initiation Protocol (SIP) Call Control - Transfer</span></span>](https://tools.ietf.org/html/rfc5589)

- [<span data-ttu-id="d832c-314">En-tête « Remplace » siP (Session Initiation Protocol)</span><span class="sxs-lookup"><span data-stu-id="d832c-314">Session Initiation Protocol (SIP) "Replaces" Header</span></span>](https://tools.ietf.org/html/rfc3891)

- [<span data-ttu-id="d832c-315">Mécanisme « Référent par » siP (Session Initiation Protocol)</span><span class="sxs-lookup"><span data-stu-id="d832c-315">Session Initiation Protocol (SIP) "Referred-By" mechanism</span></span>](https://tools.ietf.org/html/rfc3892)

<span data-ttu-id="d832c-316">Cette option suppose que le proxy SIP agit comme un transféreur et envoie un message de référence au SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-316">This option assumes that the SIP proxy acts as a Transferor and sends a Refer message to the SBC.</span></span> <span data-ttu-id="d832c-317">Le SBC agit en tant que bénéficiaire du transfert et gère la référence pour générer une nouvelle offre de transfert.</span><span class="sxs-lookup"><span data-stu-id="d832c-317">The SBC acts as a Transferee and handles the Refer to generate a new offer for transfer.</span></span> <span data-ttu-id="d832c-318">Il existe deux cas possibles :</span><span class="sxs-lookup"><span data-stu-id="d832c-318">There are two possible cases:</span></span>

- <span data-ttu-id="d832c-319">L’appel est transféré à un participant PSTN externe.</span><span class="sxs-lookup"><span data-stu-id="d832c-319">The call is transferred to an external PSTN participant.</span></span> 
- <span data-ttu-id="d832c-320">L’appel est transféré d’un Teams un utilisateur à un autre Teams dans le même client via le SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-320">The call is transferred from one Teams user to another Teams user in the same tenant via the SBC.</span></span> 

<span data-ttu-id="d832c-321">Si l’appel est transféré d’un utilisateur Teams à un autre via le SBC, le SBC est censé émettre une nouvelle invitation (démarrer une nouvelle boîte de dialogue) pour la cible de transfert (l’utilisateur Teams) à l’aide des informations reçues dans le message de référence.</span><span class="sxs-lookup"><span data-stu-id="d832c-321">If the call is transferred from one Teams user to another via the SBC, the SBC is expected to issue a new invite (start a new dialog) for the transfer target (the Teams user) using the information received in the Refer message.</span></span> 

<span data-ttu-id="d832c-322">Pour remplir les champs To/Transferor de la transaction de la demande en interne, le proxy SIP doit communiquer ces informations dans les en-têtes REFER-TO/REFERRED-BY.</span><span class="sxs-lookup"><span data-stu-id="d832c-322">To populate the To/Transferor fields for the transaction of the request internally, the SIP proxy needs to convey this information  inside the REFER-TO/REFERRED-BY headers.</span></span> 

<span data-ttu-id="d832c-323">Le proxy SIP forme l’URI REFER-TO sous la forme d’un URI SIP constitué d’un nom de famille d’accès proxy SIP dans le nom d’hôte et d’une des façons suivantes :</span><span class="sxs-lookup"><span data-stu-id="d832c-323">The SIP proxy will form the REFER-TO as a SIP URI comprised of a SIP proxy FQDN in the hostname and either one of the following:</span></span>

- <span data-ttu-id="d832c-324">Un numéro de téléphone E.164 dans la partie nom d’utilisateur de l’URI au cas où la cible du transfert serait un numéro de téléphone, ou</span><span class="sxs-lookup"><span data-stu-id="d832c-324">An E.164 phone number in the username part of the URI in case the transfer target is a phone number, or</span></span>

- <span data-ttu-id="d832c-325">Paramètres x-m et x-t codage respectivement de l’ID de locataire et de l’ID de locataire de la cible de transfert complet</span><span class="sxs-lookup"><span data-stu-id="d832c-325">x-m and x-t parameters encoding the full transfer target MRI and tenant ID respectively</span></span> 

<span data-ttu-id="d832c-326">L’en-tête RÉFÉREZ-PAR est un URI SIP avec l’encodage DE l’URI DU transféreur( URI), ainsi que l’ID de locataire du transféreur et d’autres paramètres de contexte de transfert, comme illustré dans le tableau suivant :</span><span class="sxs-lookup"><span data-stu-id="d832c-326">The REFERRED-BY header is a SIP URI with transferor MRI encoded in it as well as transferor tenant ID and other transfer context parameters as shown in the following table:</span></span>

| <span data-ttu-id="d832c-327">Paramètre</span><span class="sxs-lookup"><span data-stu-id="d832c-327">Parameter</span></span> | <span data-ttu-id="d832c-328">Valeur</span><span class="sxs-lookup"><span data-stu-id="d832c-328">Value</span></span> | <span data-ttu-id="d832c-329">Description%</span><span class="sxs-lookup"><span data-stu-id="d832c-329">Description</span></span> |  
|:---------------------  |:---------------------- |:---------------------- |
| <span data-ttu-id="d832c-330">x-m</span><span class="sxs-lookup"><span data-stu-id="d832c-330">x-m</span></span> | <span data-ttu-id="d832c-331">INSER</span><span class="sxs-lookup"><span data-stu-id="d832c-331">MRI</span></span> | <span data-ttu-id="d832c-332">FULL IRM of transferor/transfer target as populated by CC</span><span class="sxs-lookup"><span data-stu-id="d832c-332">Full MRI of transferor/transfer target as populated by CC</span></span> |
| <span data-ttu-id="d832c-333">x-t</span><span class="sxs-lookup"><span data-stu-id="d832c-333">x-t</span></span> | <span data-ttu-id="d832c-334">ID du locataire</span><span class="sxs-lookup"><span data-stu-id="d832c-334">Tenant ID</span></span> | <span data-ttu-id="d832c-335">ID de locataire x-t ID de locataire facultatif tel que rempli par CC</span><span class="sxs-lookup"><span data-stu-id="d832c-335">x-t Tenant ID Optional Tenant ID as populated by CC</span></span> |
| <span data-ttu-id="d832c-336">x-ti</span><span class="sxs-lookup"><span data-stu-id="d832c-336">x-ti</span></span> | <span data-ttu-id="d832c-337">ID de corrélation de transfert</span><span class="sxs-lookup"><span data-stu-id="d832c-337">Transferor Correlation Id</span></span> | <span data-ttu-id="d832c-338">ID de corrélation de l’appel au transféreur</span><span class="sxs-lookup"><span data-stu-id="d832c-338">Correlation ID of the call to the transferor</span></span> |
| <span data-ttu-id="d832c-339">x-tt</span><span class="sxs-lookup"><span data-stu-id="d832c-339">x-tt</span></span> | <span data-ttu-id="d832c-340">URI d’appel cible de transfert</span><span class="sxs-lookup"><span data-stu-id="d832c-340">Transfer target call URI</span></span> | <span data-ttu-id="d832c-341">URI de remplacement d’appel codé</span><span class="sxs-lookup"><span data-stu-id="d832c-341">Encoded call replacement URI</span></span> |

<span data-ttu-id="d832c-342">La taille de l’en-tête Référez-vous peut être jusqu’à 400 symboles dans ce cas.</span><span class="sxs-lookup"><span data-stu-id="d832c-342">The size of the Refer Header can be up to 400 symbols in this case.</span></span> <span data-ttu-id="d832c-343">Le SBC doit prendre en charge la gestion des messages Référez-vous qui ont une taille de 400 symboles au plus.</span><span class="sxs-lookup"><span data-stu-id="d832c-343">The SBC must support handling Refer messages with size up to 400 symbols.</span></span>

> [!div class="mx-imgBorder"]
> <span data-ttu-id="d832c-344">![Diagramme montrant plusieurs points de terminaison avec réponse inser](media/direct-routing-protocols-5.png)</span><span class="sxs-lookup"><span data-stu-id="d832c-344">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-5.png)</span></span>

## <a name="session-timer"></a><span data-ttu-id="d832c-345">Timer de session</span><span class="sxs-lookup"><span data-stu-id="d832c-345">Session timer</span></span>

<span data-ttu-id="d832c-346">Le proxy SIP prend en charge (toujours) le timer de session pour les appels sans contournement, mais ne l’offre pas lors des appels contournement.</span><span class="sxs-lookup"><span data-stu-id="d832c-346">The SIP proxy supports (always offers) the Session Timer on non-bypass calls but does not offer it on bypass calls.</span></span> <span data-ttu-id="d832c-347">L’utilisation du timer de session par le SBC n’est pas obligatoire.</span><span class="sxs-lookup"><span data-stu-id="d832c-347">Use of the Session Timer by the SBC is not mandatory.</span></span>

##  <a name="use-of-request-uri-parameter-userphone"></a><span data-ttu-id="d832c-348">Utilisation du paramètre Request-URI user=phone</span><span class="sxs-lookup"><span data-stu-id="d832c-348">Use of Request-URI parameter user=phone</span></span>

<span data-ttu-id="d832c-349">Le proxy SIP analyse l’URI-demande et si le paramètre user=phone est présent, le service traite l’URI-demande comme numéro de téléphone, correspondant au numéro à un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d832c-349">The SIP proxy analyses the Request-URI and if the parameter user=phone is present, the service will handle the Request-URI as a phone number, matching the number to a user.</span></span> <span data-ttu-id="d832c-350">Si le paramètre n’est pas présent, le proxy SIP applique les paramètres heuristiques pour déterminer le type d’utilisateur Request-URI (numéro de téléphone ou adresse SIP).</span><span class="sxs-lookup"><span data-stu-id="d832c-350">If parameter is not present the SIP proxy applies heuristics to determine  the Request-URI user type (phone number or a SIP address).</span></span>

<span data-ttu-id="d832c-351">Microsoft recommande de toujours appliquer le paramètre user=phone pour simplifier le processus de configuration de l’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-351">Microsoft recommends always applying the user=phone parameter to simplify the call setup process.</span></span>

## <a name="history-info-header"></a><span data-ttu-id="d832c-352">History-Info-tête</span><span class="sxs-lookup"><span data-stu-id="d832c-352">History-Info header</span></span>

<span data-ttu-id="d832c-353">L’en-tête History-Info est utilisé pour retargeting sip requests and " provide(s) un mécanisme standard pour capturer les informations de l’historique des demandes afin d’activer une grande variété de services pour les réseaux et les utilisateurs finaux ».</span><span class="sxs-lookup"><span data-stu-id="d832c-353">The History-Info header is used for retargeting SIP requests and “provide(s) a standard mechanism for capturing the request history information to enable a wide variety of services for networks and end-users.”</span></span> <span data-ttu-id="d832c-354">Pour plus d’informations, [voir RFC 4244 – Section 1.1.](http://www.ietf.org/rfc/rfc4244.txt)</span><span class="sxs-lookup"><span data-stu-id="d832c-354">For more information, see [RFC 4244 – Section 1.1](http://www.ietf.org/rfc/rfc4244.txt).</span></span> <span data-ttu-id="d832c-355">Pour Téléphone Microsoft système informatique, cet en-tête est utilisé dans les scénarios de simulring et de forwardage d’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-355">For Microsoft Phone System, this header is used in Simulring and Call Forwarding scenarios.</span></span>  

<span data-ttu-id="d832c-356">En cas d’envoi, le History-Info est activé comme suit :</span><span class="sxs-lookup"><span data-stu-id="d832c-356">If sending, the History-Info is enabled as follows:</span></span>

- <span data-ttu-id="d832c-357">Le proxy SIP insère un paramètre contenant le numéro de téléphone associé dans les entrées History-Info individuelles qui composent l’en-tête History-Info envoyé au contrôleur PSTN.</span><span class="sxs-lookup"><span data-stu-id="d832c-357">The SIP proxy will insert a parameter containing the associated phone number in individual History-Info entries that comprise the History-Info header sent to the PSTN Controller.</span></span>  <span data-ttu-id="d832c-358">En utilisant uniquement les entrées qui ont le paramètre de numéro de téléphone, le contrôleur PSTN reconstruira un nouvel en-tête History-Info et le transmettrea au fournisseur de ligne SIP via le proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-358">Using only entries that have the phone number parameter, the PSTN Controller will rebuild a new History-Info header, and pass it on to the SIP trunk provider via SIP proxy.</span></span>

- <span data-ttu-id="d832c-359">History-Info-tête sera ajouté pour les cas de sonnerie simultanée et de forwardage.</span><span class="sxs-lookup"><span data-stu-id="d832c-359">History-Info header will be added for simultaneous ring and call forwarding cases.</span></span>

- <span data-ttu-id="d832c-360">History-Info-tête n’est pas ajouté pour les cas de transfert d’appel.</span><span class="sxs-lookup"><span data-stu-id="d832c-360">History-Info header will not be added for call transfer cases.</span></span>

- <span data-ttu-id="d832c-361">Pour chaque entrée d’historique dans l’en-tête d'History-Info reconstruire, le paramètre de numéro de téléphone est associé à la valeur du nom de direction routage direct (sip.pstnhub.microsoft.com) définie comme partie hôte de l’URI. Un paramètre de « user=phone » sera ajouté dans le cadre de l’URI SIP.</span><span class="sxs-lookup"><span data-stu-id="d832c-361">An individual history entry in the reconstructed History-Info header will have the phone number parameter provided combined with the Direct Routing FQDN (sip.pstnhub.microsoft.com) set as the host part of the URI; a parameter of ‘user=phone’ will be added as part of the SIP URI.</span></span>  <span data-ttu-id="d832c-362">Tous les autres paramètres associés à l’en-History-Info d’origine, à l’exception des paramètres de contexte du téléphone, sont transmis dans l’en-tête History-Info'origine.</span><span class="sxs-lookup"><span data-stu-id="d832c-362">Any other parameters associated with the original History-Info header, except for phone context parameters, will be passed through in the re-constructed History-Info header.</span></span>  

  > [!NOTE]
  > <span data-ttu-id="d832c-363">Les entrées privées (telles que déterminées par les mécanismes définis dans la section 3.3 de la mise à jour RFC 4244) seront également transmis, car le fournisseur de ligne SIP est un homologue approuvé.</span><span class="sxs-lookup"><span data-stu-id="d832c-363">Entries that are private (as determined by the mechanisms defined in Section 3.3 of RFC 4244) will be forwarded as is because  the SIP trunk provider is a trusted peer.</span></span>

- <span data-ttu-id="d832c-364">Les appels entrants History-Info sont ignorés.</span><span class="sxs-lookup"><span data-stu-id="d832c-364">Inbound History-Info is ignored.</span></span>

<span data-ttu-id="d832c-365">Voici le format de l’en-tête History-info envoyé par le proxy SIP :</span><span class="sxs-lookup"><span data-stu-id="d832c-365">Following is the format of the History-info header sent by the SIP proxy:</span></span>

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

<span data-ttu-id="d832c-366">Si l’appel a été redirigé plusieurs fois, les informations sur chaque redirection sont incluses avec la raison appropriée dans l’ordre chronologique.</span><span class="sxs-lookup"><span data-stu-id="d832c-366">If the call was redirected several times, information about every redirect is included with the appropriate reason in chronological order.</span></span>


<span data-ttu-id="d832c-367">Exemple d’en-tête :</span><span class="sxs-lookup"><span data-stu-id="d832c-367">Header Example:</span></span>

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

<span data-ttu-id="d832c-368">Le History-Info est protégé par un mécanisme TLS obligatoire.</span><span class="sxs-lookup"><span data-stu-id="d832c-368">The History-Info is protected by a mandatory TLS mechanism.</span></span> 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a><span data-ttu-id="d832c-369">Connexion SBC au routage direct et au mécanisme de resserrement</span><span class="sxs-lookup"><span data-stu-id="d832c-369">SBC connection to Direct Routing and failover mechanism</span></span>

<span data-ttu-id="d832c-370">Consultez le mécanisme deover de section pour le signalisation SIP dans [Plan pour le routage direct.](direct-routing-plan.md#failover-mechanism-for-sip-signaling)</span><span class="sxs-lookup"><span data-stu-id="d832c-370">See the section Failover mechanism for SIP signaling in [Plan for Direct Routing](direct-routing-plan.md#failover-mechanism-for-sip-signaling).</span></span>

## <a name="retry-after"></a><span data-ttu-id="d832c-371">Retry-After</span><span class="sxs-lookup"><span data-stu-id="d832c-371">Retry-After</span></span>

<span data-ttu-id="d832c-372">Si un centre de données de routage direct est occupé, le service peut envoyer un message Retry-After intervalle d’une seconde au SBC.</span><span class="sxs-lookup"><span data-stu-id="d832c-372">If a Direct Routing datacenter is busy, the service can send a Retry-After message with a one-second interval to the SBC.</span></span> <span data-ttu-id="d832c-373">Lorsque le SBC reçoit un message 503 avec un en-tête Retry-After en réponse à une invitation, il doit mettre fin à cette connexion et essayer le prochain centre de données Microsoft disponible.</span><span class="sxs-lookup"><span data-stu-id="d832c-373">When the SBC receives a 503 message with a Retry-After header in response to an INVITE, the SBC must terminate that connection and try the next available Microsoft datacenter.</span></span>

## <a name="handling-retries-603-response"></a><span data-ttu-id="d832c-374">Gestion des dossiers (réponse 603)</span><span class="sxs-lookup"><span data-stu-id="d832c-374">Handling retries (603 response)</span></span>
<span data-ttu-id="d832c-375">Si un utilisateur final observe plusieurs appels manqués pour un appel après le refus de l’appel entrant, cela signifie que le mécanisme de nouvelle tentative de réessayation du fournisseur SBC ou PSTN est configuré de façon non configurée.</span><span class="sxs-lookup"><span data-stu-id="d832c-375">If an end user observes several missed calls for one call after declining the incoming call, it means that the SBC or PSTN trunk provider's retry mechanism is misconfigured.</span></span> <span data-ttu-id="d832c-376">Le SBC doit être reconfiguré pour arrêter les efforts de réessayation sur la réponse 603.</span><span class="sxs-lookup"><span data-stu-id="d832c-376">The SBC must be reconfigured to stop the retry efforts on the 603 response.</span></span>

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a><span data-ttu-id="d832c-377">Redémarrage ICE : Appel de dérivation média transféré vers un point de terminaison qui ne prend pas en charge la dérivation média</span><span class="sxs-lookup"><span data-stu-id="d832c-377">ICE Restart: Media bypass call transferred to an endpoint that does not support media bypass</span></span>

<span data-ttu-id="d832c-378">Le SBC doit prendre en charge les redémarrages ICE, comme décrit dans la [rubrique RFC 5245, section 9.1.1.1.](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)</span><span class="sxs-lookup"><span data-stu-id="d832c-378">The SBC must support ICE restarts as described in [RFC 5245, section 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).</span></span>

<span data-ttu-id="d832c-379">Le redémarrage dans le routage direct est implémenté conformément aux paragraphes suivants de la mise en route RFC :</span><span class="sxs-lookup"><span data-stu-id="d832c-379">The restart in Direct Routing is implemented according to the following paragraphs of the RFC:</span></span>

<span data-ttu-id="d832c-380">*Pour redémarrer la glace, un agent doit modifier le ice-pwd et le ice-ufrag pour le flux multimédia dans une offre.  Notez qu’il est possible d’utiliser un attribut au niveau de la session dans une offre, mais de fournir le même attribut ice-pwd ou ice-ufrag comme attribut de niveau multimédia dans une offre ultérieure.  Il ne s’agit pas d’une modification du mot de passe, mais d’une modification de sa représentation, et ne provoque pas de redémarrage de ICE.*</span><span class="sxs-lookup"><span data-stu-id="d832c-380">*To restart ICE, an agent MUST change both the ice-pwd and the ice-ufrag for the media stream in an offer.  Note that it is permissible to use a session-level attribute in one offer, but to provide the same ice-pwd or ice-ufrag as a media-level attribute in a subsequent offer.  This is not a change in password, just a change in its representation, and does not cause an ICE restart.*</span></span>

<span data-ttu-id="d832c-381">*Un agent définit le reste des champs dans le SDP pour ce flux multimédia comme il le ferait dans une offre initiale de ce flux multimédia (voir la section 4.3).  Par conséquent, l’ensemble des candidats peut inclure une partie, aucun ou l’ensemble des candidats précédents pour ce flux et PEUT inclure un ensemble totalement nouveau de candidats rassemblés, comme décrit dans la section 4.1.1.*</span><span class="sxs-lookup"><span data-stu-id="d832c-381">*An agent sets the rest of the fields in the SDP for this media stream as it would in an initial offer of this media stream (see Section 4.3).  Consequently, the set of candidates MAY include some, none, or all of the previous candidates for that stream and MAY include a totally new set of candidates gathered as described in Section 4.1.1.*</span></span>

<span data-ttu-id="d832c-382">Si l’appel a été établi à l’origine avec une dérivation média et que l’appel est transféré vers un client Skype Entreprise, le routage direct doit insérer un processeur de média, car il est impossible d’utiliser le routage direct avec un client Skype Entreprise avec une dérivation média.</span><span class="sxs-lookup"><span data-stu-id="d832c-382">If the call was initially established with media bypass, and the call is transferred to a Skype for Business client, Direct Routing needs to insert a Media Processor--this is because Direct Routing cannot be used with a Skype for Business client with media bypass.</span></span> <span data-ttu-id="d832c-383">Le routage direct lance le processus de redémarrage de ice pwd et ice-ufrag et propose de nouveaux candidats multimédias dans une réinvitation.</span><span class="sxs-lookup"><span data-stu-id="d832c-383">Direct Routing starts the ICE restart process by  changing the ice-pwd and ice-ufrag and offering new media candidates in a reinvite.</span></span>
